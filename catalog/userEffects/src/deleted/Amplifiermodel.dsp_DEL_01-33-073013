declare name "Hammerstein modelisation";
declare version 	"1.0";
declare author 		"V.Bisot - S.Leglaive";

//-----------------------------------------------------------------------------------
//	Modelisation of a Peavey guitar amplifier using Cascade of Hammerstein model
//-----------------------------------------------------------------------------------

import("filter.lib");
import("music.lib");

//----------------------Cascade of Hammerstein-------------------------------
// hammer(x,V,G)
//				x : Input signal
//				V : Volume
//				G : gain
//
//--------------------------------------------------------------------------------

//----------------------Volume and gain controls-------------------------------

vol  = hslider("volume (dB)", 0, -20, +20, 0.1) : db2linear : smooth(0.999);
gain = hslider("gain (dB)", 0, 0, 5, 0.01) : db2linear : smooth(0.999);

bp = checkbox("Bypass");

amp1 = checkbox("Peavey faible gain");
amp2 = checkbox("Peavey fort gain");

hmeter(x) = attach(x, envelop(x) : hbargraph("[2][unit:dB]", -70, +5));
envelop	 = abs : max ~ -(1.0/SR) : max(db2linear(-70)): linear2db;

//----------------------Filter coefficients of the cascade n¬∞1-------------------------------

acoeffs11 = (-2.2497351,1.5122114,0.1883263,-0.4113389,-0.2093643,0.1617711,0.1855828,-0.0477354,-0.1567711,-0.0272359,0.1112223,0.0665314,-0.0665637,-0.0888411,0.0130584,0.0787048,0.0229799,-0.0566174,-0.0430528,0.0316112,0.0508288,-0.0079762,-0.0495700,-0.0111539,0.0469842,0.0381575,-0.0214289,-0.0424355,0.0021274,0.0409241,0.0156035,-0.0323736,-0.0275681,0.0239288,0.0432858,-0.0025773,-0.0500738,-0.0308691,0.0289234,0.0464827,0.0001281,-0.0430113,-0.0248951,0.0242747,0.0351486,-0.0020308,-0.0312820,-0.0162962,0.0131916,0.0149235,-0.0030341,-0.0045594,0.0110809,0.0097635,-0.0152533,-0.0243834,0.0060351,0.0366999,0.0167881,-0.0344017,-0.0427903,0.0176040,0.0803877,-0.0600915);

acoeffs12 = (-1.9017764,1.0298400,0.2349706,-0.1785216,-0.1327385,0.0514057,0.0860645,-0.0119728,-0.0607804,0.0047908,0.0762222,0.0508544,-0.0322388,-0.0648490,-0.0174748,0.0400923,0.0449871,0.0124206,-0.0087757,-0.0075526,-0.0066892,-0.0111310,-0.0004781,0.0267968,0.0372711,0.0089868,-0.0283615,-0.0264470,0.0158088,0.0470569,0.0298997,-0.0111571,-0.0247574,-0.0002512,0.0240820,0.0175975,-0.0040282,-0.0081525,0.0063919,0.0124976,-0.0002715,-0.0095152,0.0035873,0.0220838,0.0161087,-0.0115246,-0.0253026,-0.0056775,0.0224728,0.0231667,-0.0019046,-0.0176757,-0.0056798,0.0122238,0.0088702,-0.0074718,-0.0071616,0.0130367,0.0211868,-0.0022905,-0.0283113,-0.0117435,0.0455294,-0.0035088);

acoeffs13 = (-2.2027234,1.8040625,-0.0564771,-0.5407893,-0.0601678,0.3297824,0.1648367,-0.1589525,-0.1592398,0.0866406,0.1813306,0.0158510,-0.1361152,-0.0660521,0.0888691,0.0933249,-0.0381785,-0.0982223,-0.0114942,0.0723234,0.0245529,-0.0731163,-0.0679623,0.0297856,0.0716215,-0.0008488,-0.0746008,-0.0416149,0.0433018,0.0536197,-0.0184606,-0.0590056,-0.0087865,0.0524439,0.0331292,-0.0326644,-0.0427910,0.0163733,0.0532042,0.0130058,-0.0411278,-0.0273919,0.0313343,0.0462373,-0.0016882,-0.0372221,-0.0096389,0.0320624,0.0206844,-0.0227867,-0.0252323,0.0188714,0.0363217,-0.0065832,-0.0441220,-0.0123159,0.0433629,0.0315370,-0.0366238,-0.0513218,0.0227663,0.0623076,-0.0539602,0.0105199);

acoeffs14 = (-2.4807960,2.4982080,-0.7386469,-0.4952526,0.1978630,0.2940901,-0.0294426,-0.2024043,-0.0548562,0.1246541,0.0902128,-0.0595479,-0.0967929,0.0029151,0.0736289,0.0238276,-0.0512412,-0.0370738,0.0340274,0.0496796,-0.0095428,-0.0514704,-0.0162299,0.0396203,0.0351128,-0.0170433,-0.0377300,-0.0011027,0.0318842,0.0106019,-0.0314664,-0.0297525,0.0132073,0.0338981,0.0022444,-0.0355481,-0.0255312,0.0156708,0.0287326,-0.0018748,-0.0287388,-0.0129538,0.0204753,0.0234290,-0.0053574,-0.0217750,-0.0040033,0.0174732,0.0087837,-0.0164931,-0.0197219,0.0029955,0.0157589,-0.0011380,-0.0210650,-0.0124739,0.0118999,0.0137570,-0.0093758,-0.0187373,0.0051898,0.0211159,-0.0249869,0.0103857);

//----------------------Filter coefficients of the cascade n¬∞2-------------------------------

acoeffs21 = (-2.3762291,1.8741680,-0.0403942,-0.5472664,-0.0989236,0.2688355,0.1329814,-0.1456939,-0.1522693,0.0482060,0.1346097,0.0160503,-0.1042377,-0.0658219,0.0449231,0.0646944,-0.0095103,-0.0509373,-0.0070106,0.0398814,0.0163166,-0.0329768,-0.0262605,0.0258491,0.0415155,-0.0034432,-0.0401134,-0.0138068,0.0334236,0.0289393,-0.0191392,-0.0345894,0.0101455,0.0495160,0.0208302,-0.0408075,-0.0499018,0.0070094,0.0513165,0.0235960,-0.0340632,-0.0407995,0.0085619,0.0410580,0.0131539,-0.0301923,-0.0263693,0.0135796,0.0267433,-0.0047988,-0.0292106,-0.0068483,0.0280639,0.0204361,-0.0197170,-0.0315918,0.0022851,0.0283468,0.0070442,-0.0220356,-0.0056254,0.0224019,-0.0246289,0.0168049);

acoeffs22 = (-1.9091274,1.2403773,0.1327835,-0.3061898,-0.1156054,0.1550818,0.1396908,-0.0460770,-0.1130846,-0.0050076,0.0927599,0.0484900,-0.0563737,-0.0766961,-0.0060229,0.0425097,0.0098196,-0.0407456,-0.0342643,0.0078756,0.0137742,-0.0249502,-0.0436889,-0.0055482,0.0421390,0.0362053,-0.0125808,-0.0369461,-0.0075985,0.0313133,0.0298377,0.0003947,-0.0077991,0.0170187,0.0355927,0.0188659,-0.0096452,-0.0101807,0.0152783,0.0279225,0.0093288,-0.0135382,-0.0089105,0.0152692,0.0253962,0.0099063,-0.0087811,-0.0096859,-0.0000626,0.0022988,-0.0023138,-0.0009512,0.0059774,0.0041681,-0.0079136,-0.0113803,0.0038778,0.0179625,0.0073481,-0.0156381,-0.0151063,0.0107612,0.0095723,0.0074794);

acoeffs23 = (-2.2681467,1.7802484,-0.0110758,-0.5280668,-0.0757539,0.3002501,0.1486583,-0.1446380,-0.1350222,0.0909313,0.1712539,0.0203086,-0.1125003,-0.0478363,0.0914167,0.1029981,-0.0026685,-0.0551102,0.0088681,0.0724783,0.0361335,-0.0354120,-0.0254045,0.0532799,0.0820074,0.0174770,-0.0461203,-0.0192395,0.0542187,0.0673314,0.0066339,-0.0356086,-0.0013125,0.0529749,0.0467046,-0.0060807,-0.0242904,0.0162853,0.0503304,0.0248455,-0.0216748,-0.0192357,0.0286394,0.0518596,0.0182872,-0.0219458,-0.0143449,0.0211182,0.0268642,-0.0018983,-0.0136364,0.0138805,0.0356395,0.0110227,-0.0269477,-0.0184456,0.0271496,0.0386486,-0.0064705,-0.0373947,0.0032054,0.0477338,-0.0308678,0.0164173);

acoeffs24 = (-2.2004626,1.7446251,-0.0888672,-0.4488488,-0.0354885,0.2601932,0.1243981,-0.1164877,-0.1098216,0.0763511,0.1506530,0.0338693,-0.0796421,-0.0374141,0.0719076,0.0838104,-0.0001810,-0.0414019,0.0164923,0.0747449,0.0411240,-0.0325000,-0.0351925,0.0362205,0.0773342,0.0322631,-0.0298668,-0.0225271,0.0342859,0.0528369,0.0103456,-0.0238299,0.0016710,0.0441550,0.0356127,-0.0130233,-0.0295447,0.0101550,0.0464652,0.0255361,-0.0217121,-0.0270473,0.0148917,0.0419252,0.0173764,-0.0197473,-0.0175607,0.0127831,0.0209204,-0.0023942,-0.0147123,0.0061799,0.0247391,0.0056702,-0.0250779,-0.0175148,0.0209330,0.0309957,-0.0058750,-0.0318106,-0.0016130,0.0322796,-0.0187584,0.0059069);


//----------------------Cascade of Hammerstein modelisation-------------------------------

hammer1(x,V,G) =  ( G*x : iir(1.3201e-2,acoeffs11) ) + 
	( ( G*x , 2 : pow) : iir(3.3534e-3,acoeffs12) ) +
	( ( ( G*x : lowpass(5,20000/3)) , 3 : pow) : iir(5.3811e-4,acoeffs13) ) + 
	( ( ( G*x : lowpass(5,20000/4)) , 4 : pow) : iir(1.5991e-4,acoeffs14) ) ;

hammer2(x,V,G) =  ( G*x : iir(1.0829e-2,acoeffs21) ) + 
	( ( G*x , 2 : pow) : iir(6.1336e-3,acoeffs22) ) +
	( ( ( G*x : lowpass(5,20000/3)) , 3 : pow) : iir(5.8937e-3,acoeffs23) ) + 
	( ( ( G*x : lowpass(5,20000/4)) , 4 : pow) : iir(4.4103e-3,acoeffs24) ) ;

routing(x,V,G,R) = R*V*x + (1-R)*(V*3)*( (amp1==1)*(amp2==0)*hammer1(x,V,G) + (amp2==1)*(amp1==0)*hammer2(x,V,G) );

//----------------------Cascade of Hammerstein process-------------------------------

process(x) = routing(x,vol,gain,bp) : hmeter <: _ , _ ;
